<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE book [
<!ENTITY % sgml.features "IGNORE">
<!ENTITY % xml.features "INCLUDE">
<!ENTITY % DOCBOOK_ENTS PUBLIC "-//OASIS//ENTITIES DocBook Character Entities V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/dbcentx.mod">
%DOCBOOK_ENTS;
]>
<?asciidoc-toc maxdepth="3"?><book xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0">
<info>
<title>Infrastructure Migration Solution Guide</title><subtitle>Migrating from VMware to Red Hat Virtualization or Red Hat OpenStack Platform</subtitle>

<date>2019-06-10</date>
<productname>Red Hat Infrastructure Migration Solution</productname>
<productnumber>1.1</productnumber>
<abstract>
    <para>This guide describes how to plan, perform, and troubleshoot an infrastructure migration from VMware to Red Hat Virtualization or Red Hat OpenStack Platform. The migration is performed with Red Hat CloudForms.</para>
</abstract>
<xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="Author_Group.xml"/>
</info>
<chapter xml:id="IMS_overview">
<title>Infrastructure Migration Solution overview</title>
<simpara>The Red Hat Infrastructure Migration Solution (IMS) enables you to migrate virtual machines from VMware 5.5 (and later) to the following target environments:</simpara>
<itemizedlist>
<listitem>
<simpara>Red Hat Virtualization 4.2</simpara>
<simpara>Red Hat Virtualization is a virtualization platform built on Red Hat Enterprise Linux. You can manage your virtual infrastructure, including hosts, virtual machines, networks, storage, and users, from a centralized graphical user interface or with a REST API. For more information, see the <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/">Red Hat Virtualization documentation</link>.</simpara>
</listitem>
<listitem>
<simpara>Red Hat OpenStack Platform 13 or 14</simpara>
<simpara>Red Hat OpenStack Platform enables you to create a scaleable, fault-tolerant, private or public cloud based on Red Hat Enterprise Linux. For more information, see the <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_openstack_platform/14/">Red Hat OpenStack Platform documentation</link>.</simpara>
</listitem>
</itemizedlist>
<simpara>The migration process is performed with CloudForms 4.7, a user interface for managing the infrastructure. For more information, see the <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.7/">Red Hat CloudForms documentation</link>.</simpara>
<simpara>The migration process has the following key steps:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Planning the migration (see <xref linkend="Planning_the_migration"/>):</simpara>
<itemizedlist>
<listitem>
<simpara>Questions to ask before migration to estimate time and resource requirements, including the following (see <xref linkend="Questions_to_ask_before_migration"/>):</simpara>
<itemizedlist>
<listitem>
<simpara>"How long will the migration take?"</simpara>
</listitem>
<listitem>
<simpara>"How many conversion hosts do I need?"</simpara>
</listitem>
<listitem>
<simpara>"Which datapath transformation option should I use, VDDK or SSH?"</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Recommendations to minimize the impact on your users (see <xref linkend="Recommendations_for_migration"/>)</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Preparing the environment for migration (see <xref linkend="Preparing_the_environment_for_migration"/>):</simpara>
<itemizedlist>
<listitem>
<simpara>Preparing the VMware environment</simpara>
</listitem>
<listitem>
<simpara>Preparing the Red Hat Virtualization or Red Hat OpenStack Platform environment</simpara>
</listitem>
<listitem>
<simpara>Configuring the conversion hosts.  Conversion hosts are Red Hat Virtualization hosts or Red Hat OpenStack Platform instances running <literal>virt-v2v</literal> and <literal>virt-v2v-wrapper</literal>, which perform the migration.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Migrating the virtual machines (see <xref linkend="Migrating_the_infrastructure"/>):</simpara>
<itemizedlist>
<listitem>
<simpara>Mapping the source and target environments</simpara>
</listitem>
<listitem>
<simpara>Creating and running a migration plan. Optionally, you can automate tasks before and after migration with Ansible.</simpara>
<simpara>For a detailed description of the migration process, see the migration workflows:</simpara>
<itemizedlist>
<listitem>
<simpara><xref linkend="Vmware_to_rhv_migration_workflow"/></simpara>
</listitem>
<listitem>
<simpara><xref linkend="Vmware_to_osp_migration_workflow"/></simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
<section xml:id="Vmware_to_rhv_migration_workflow">
<title>Red Hat Virtualization migration workflow</title>
<simpara>This diagram describes the workflow of a migration from VMware to Red Hat Virtualization.</simpara>
<figure>
<title>VMware to Red Hat Virtualization migration workflow</title>
<mediaobject>
<imageobject>
<imagedata fileref="images/vmware_to_rhv_migration_workflow.png"/>
</imageobject>
<textobject><phrase>vmware to rhv migration workflow</phrase></textobject>
</mediaobject>
</figure>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/1.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> You create and run a migration plan in CloudForms.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/2.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> CloudForms uses the migration plan to locate the source virtual machines.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/3.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> If you are using <link linkend="Choosing_vddk_or_ssh_transformation">VDDK transformation</link>, CloudForms captures the ESXi host fingerprint for authentication during the virtual machine conversion process.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/4.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> Using the attributes defined for the Red Hat Virtualization environment, CloudForms initiates communication with the conversion hosts (Red Hat Virtualization hosts with <literal>virt-v2v</literal> and <literal>virt-v2v-wrapper</literal> installed).</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/5.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> <literal>virt-v2v-wrapper</literal> connects to the source datastore through the ESXi host. <literal>virt-v2v</literal> streams the source disks to the target data domain and converts the source disks.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/6.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> <literal>virt-v2v-wrapper</literal> creates a target Red Hat Virtualization virtual machine, using the source virtual machine’s metadata in order to maintain its attributes (tags, power state, MAC address, CPU count, memory, disks, and virtual machine name) after migration.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/7.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> <literal>virt-v2v</literal> attaches the converted disks to the Red Hat Virtualization virtual machine. (The virtual machine’s power state is the same as the source virtual machine’s power state.)</simpara>
<simpara>The migration process is complete and the migration plan’s status is displayed in CloudForms.</simpara>
</section>
<section xml:id="Vmware_to_osp_migration_workflow">
<title>Red Hat OpenStack Platform migration workflow</title>
<simpara>This diagram describes the workflow of a migration from VMware to Red Hat OpenStack Platform.</simpara>
<figure>
<title>VMware to Red Hat OpenStack Platform migration workflow</title>
<mediaobject>
<imageobject>
<imagedata fileref="images/vmware_to_osp_migration_workflow.png"/>
</imageobject>
<textobject><phrase>vmware to osp migration workflow</phrase></textobject>
</mediaobject>
</figure>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/1.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> You create and run a migration plan in CloudForms.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/2.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> CloudForms uses the migration plan to locate the source virtual machines.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/3.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> If you are using <link linkend="Choosing_vddk_or_ssh_transformation">VDDK transformation</link>, CloudForms captures the ESXi host fingerprint for authentication during the virtual machine conversion process.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/4.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> Using the attributes defined for the Red Hat OpenStack Platform environment, CloudForms initiates communication with the conversion hosts (Red Hat OpenStack Platform instances created from a conversion host appliance, with <literal>virt-v2v</literal> and <literal>virt-v2v-wrapper</literal> installed).</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/5.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> <literal>virt-v2v-wrapper</literal> connects to the source datastore through the ESXi host. <literal>virt-v2v</literal> streams the source disks to the target data domain and converts the source disks.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/6.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> After the source disks are converted, <literal>virt-v2v</literal> detaches the volumes from the conversion host, migrates the volumes to the destination project, and creates the network ports defined in the infrastructure mapping.</simpara>
<simpara><inlinemediaobject>
<imageobject>
<imagedata fileref="images/circle_step_numbers/7.png" contentwidth="25"/>
</imageobject>
<textobject><phrase>25</phrase></textobject>
</inlinemediaobject> <literal>virt-v2v-wrapper</literal> creates the target Red Hat OpenStack Platform instance with the flavor and security group defined in the migration plan. <literal>virt-v2v</literal> attaches the newly created network ports and the disks mapped in the block storage to the instance and the instance is powered on.</simpara>
<simpara>The migration process is complete and the migration plan’s status is displayed in CloudForms.</simpara>
</section>
</chapter>
<chapter xml:id="Planning_the_migration">
<title>Planning the migration</title>
<simpara>During the planning phase, you will formulate a specific migration goal, for example, "I want to migrate 2000 virtual machines, with 200 TB of data, in less than 6 months".</simpara>
<simpara>The following information can help you plan your migration:</simpara>
<itemizedlist>
<listitem>
<simpara><link linkend="Questions_to_ask_before_migration">Questions to ask before migration</link>:</simpara>
<itemizedlist>
<listitem>
<simpara><link linkend="How_long_will_the_migration_take">"How long will the migration take?"</link></simpara>
<itemizedlist>
<listitem>
<simpara><xref linkend="Rhv_migration_example"/></simpara>
</listitem>
<listitem>
<simpara><xref linkend="osp_migration_example"/></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara><link linkend="Deciding_how_many_conversion_hosts_to_create">"How many conversion hosts do I need?"</link></simpara>
</listitem>
<listitem>
<simpara><link linkend="Choosing_vddk_or_ssh_transformation">"Which datapath transformation option, VDDK or SSH?"</link></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara><xref linkend="Recommendations_for_migration"/>:</simpara>
<itemizedlist>
<listitem>
<simpara><xref linkend="Distributing_the_migration_workload"/></simpara>
</listitem>
<listitem>
<simpara><xref linkend="Controlling_the_migration_process"/></simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<section xml:id="Questions_to_ask_before_migration">
<title>Questions to ask before migration</title>
<simpara>The following questions can help you to estimate the resources and time required for migration.</simpara>
<variablelist>
<varlistentry>
<term>What am I migrating?</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Identify the virtual machines to be migrated.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>What is the maximum number of disks or virtual machines that I can migrate?</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>There is no maximum number of disks or virtual machines that you can migrate. However, you may not want to migrate all your virtual machines at the same time, in order to minimize the impact on your users.</simpara>
<important>
<simpara>If you exceed the capabilities of your environment, the migrations will fail. This situation could affect existing applications running on virtual machines attached to the network and storage.</simpara>
</important>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>What operating systems can I migrate?</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>For a list of supported guest operating systems, see <link xlink:href="https://access.redhat.com/articles/1351473">Converting Virtual Machines from Other Hypervisors to KVM with virt-v2v in RHEL 7 </link>.</simpara>
</listitem>
<listitem>
<simpara>For a list of certified guest operating systems, see <link xlink:href="https://access.redhat.com/articles/973163">Certified Guest Operating Systems in Red Hat OpenStack Platform and Red Hat Virtualization</link>.</simpara>
<simpara>Although it is possible to migrate guest operating systems that are not certified for Red Hat Virtualization or Red Hat OpenStack Platform, these guests are not officially supported.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>What resources does my target environment require?</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Your target environment must be large enough to run the migrated virtual machines in addition to the source virtual machines. The source virtual machines are not affected by the migration process.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>What am I missing?</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Identify resource gaps, such as bandwidth, storage, licenses, or a suitable maintenance window.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
<varlistentry>
<term>What impact will the migration have on my users?</term>
<listitem>
<itemizedlist>
<listitem>
<simpara>Assess the effects the migration may have on a production environment.</simpara>
<simpara>It may be possible to migrate your applications in phases, without downtime at the application layer, if the applications are distributed in a high-availability architecture.</simpara>
</listitem>
<listitem>
<simpara>Check whether users will lose access to critical applications.</simpara>
</listitem>
</itemizedlist>
</listitem>
</varlistentry>
</variablelist>
<section xml:id="How_long_will_the_migration_take">
<title>How long will the migration take?</title>
<simpara>There are no specific rules to determine how long the actual migration will take. This is determined on a case-by-case basis.</simpara>
<simpara>The following migration examples are provided as a guide.</simpara>
<example xml:id="Rhv_migration_example">
<title>Red Hat Virtualization migration</title>
<itemizedlist>
<listitem>
<simpara>Duration of migration: 1:15:53 (<emphasis>hh:mm:ss</emphasis>)</simpara>
</listitem>
<listitem>
<simpara>10 virtual machines</simpara>
</listitem>
<listitem>
<simpara>Total data migrated, using VDDK: 1000 GB</simpara>
</listitem>
<listitem>
<simpara>Hardware:</simpara>
<itemizedlist>
<listitem>
<simpara>Strong host (40 cores, 500 GB RAM)</simpara>
</listitem>
<listitem>
<simpara>Fast SSD XtremIO storage</simpara>
</listitem>
<listitem>
<simpara>Fibre Channel 8 interface for host-to-storage connection</simpara>
</listitem>
<listitem>
<simpara>10 GbE network interface cards for all other connections</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
</example>
<example xml:id="osp_migration_example">
<title>Red Hat OpenStack Platform migration</title>
<itemizedlist>
<listitem>
<simpara>Duration of migration: 2:13:00 (<emphasis>hh:mm:ss</emphasis>)</simpara>
</listitem>
<listitem>
<simpara>20 virtual machines</simpara>
</listitem>
<listitem>
<simpara>2 conversion hosts, maximum of 10 concurrent conversions</simpara>
</listitem>
<listitem>
<simpara>Total data migrated, using VDDK: 1000 GB</simpara>
</listitem>
<listitem>
<simpara>Hardware: See <xref linkend="Rhv_migration_example"/></simpara>
</listitem>
</itemizedlist>
</example>
</section>
<section xml:id="Deciding_how_many_conversion_hosts_to_create">
<title>How many conversion hosts do I need?</title>
<simpara>The number of conversion hosts you create depends on the size of your migration. All the virtual machines in the migration plan are migrated at the same time, in parallel. The number of virtual machines that you can migrate simultaneously depends on your infrastructure capabilities. Each migration requires a certain amount of network bandwidth, I/O throughput, and processing power for the conversion process.</simpara>
<simpara>Multiple conversion hosts provide load-balancing and better performance, even for small migrations.</simpara>
<simpara>Conversion hosts and providers are limited to ten concurrent migrations, unless you change the default maximum number of concurrent migrations (see <xref linkend="Changing_the_maximum_number_of_concurrent_migrations"/>).</simpara>
<simpara>Test your environment thoroughly before the migration to determine how many migrations it can support without negative effects, for example, five conversion hosts, each running ten concurrent migrations.</simpara>
</section>
<section xml:id="Choosing_vddk_or_ssh_transformation">
<title>Which transformation method, VDDK or SSH?</title>
<simpara>You will configure the conversion hosts to use either the VMware Virtual Disk Development Kit (VDDK) or SSH as the transformation method for converting the virtual machines. The choice is determined by the number of virtual machines you are migrating and the capabilities of your infrastructure.</simpara>
<simpara>The following table compares the options.</simpara>
<table frame="all" rowsep="1" colsep="1">
<title>VDDK and SSH comparison</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="20*"/>
<colspec colname="col_2" colwidth="40*"/>
<colspec colname="col_3" colwidth="40*"/>
<thead>
<row>
<entry align="left" valign="top"/>
<entry align="center" valign="top">Pros</entry>
<entry align="center" valign="top">Cons</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara><emphasis role="strong">VDDK</emphasis></simpara></entry>
<entry align="left" valign="top"><itemizedlist>
<listitem>
<simpara>Recommended because it is approximately twice as fast as SSH</simpara>
</listitem>
<listitem>
<simpara>Compiled with <literal>nbdkit</literal>, which provides direct connectivity to the virtual machine disks</simpara>
</listitem>
</itemizedlist></entry>
<entry align="left" valign="top"><itemizedlist>
<listitem>
<simpara>Requires VDDK package download</simpara>
</listitem>
<listitem>
<simpara>Requires VDDK library location for configuring the conversion hosts</simpara>
</listitem>
<listitem>
<simpara>Limited to 20 concurrent migrations per conversion host due to ESXi memory limitation. See <link xlink:href="http://libguestfs.org/virt-v2v.1.html#vddk:-esxi-nfc-service-memory-limits">VDDK: ESXi NFC SERVICE MEMORY LIMITS</link> in <link xlink:href="http://libguestfs.org/virt-v2v.1.html">virt-v2v - Convert a guest to use KVM</link> for details.</simpara>
</listitem>
</itemizedlist></entry>
</row>
<row>
<entry align="left" valign="top"><simpara><emphasis role="strong">SSH</emphasis></simpara></entry>
<entry align="left" valign="top"><itemizedlist>
<listitem>
<simpara>Better suited for large-scale migrations than VDDK (not affected by ESXi memory limitation)</simpara>
</listitem>
<listitem>
<simpara>Does not require additional downloads, packages, tools, or compilation</simpara>
</listitem>
</itemizedlist></entry>
<entry align="left" valign="top"><itemizedlist>
<listitem>
<simpara>Slower than VDDK</simpara>
</listitem>
<listitem>
<simpara>Requires the VMware hypervisors to have SSH access enabled</simpara>
</listitem>
<listitem>
<simpara>Requires shared SSH keys for the source and target environments</simpara>
</listitem>
</itemizedlist></entry>
</row>
</tbody>
</tgroup>
</table>
</section>
</section>
<section xml:id="Recommendations_for_migration">
<title>Recommendations for migration</title>
<simpara>The following recommendations will minimize the impact of the migration on your environment.</simpara>
<itemizedlist>
<title>Scheduling the migration</title>
<listitem>
<simpara>Schedule your migration carefully, to minimize the impact on your users.</simpara>
</listitem>
<listitem>
<simpara>Prepare your users for downtime.</simpara>
<important>
<simpara>Currently, IMS supports only cold migration. Virtual machines are powered off gracefully as part of the migration process.</simpara>
</important>
</listitem>
<listitem>
<simpara>Stagger the migration schedules.</simpara>
</listitem>
<listitem>
<simpara>Move critical applications during maintenance windows.</simpara>
</listitem>
</itemizedlist>
<itemizedlist xml:id="Distributing_the_migration_workload">
<title>Distributing the migration workload</title>
<listitem>
<simpara>Create migration groups, so that you are not migrating all of your virtual machines at the same time, keeping in mind the following considerations:</simpara>
<itemizedlist>
<listitem>
<simpara>How are the virtual machines grouped now?</simpara>
</listitem>
<listitem>
<simpara>Which virtual machines should be migrated together?</simpara>
</listitem>
<listitem>
<simpara>Which workloads or linked applications should be migrated together?</simpara>
</listitem>
<listitem>
<simpara>What applications must remain available?</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Consider which parts of the workload to migrate first:</simpara>
<itemizedlist>
<listitem>
<simpara>Databases</simpara>
</listitem>
<listitem>
<simpara>Applications</simpara>
</listitem>
<listitem>
<simpara>Web servers</simpara>
</listitem>
<listitem>
<simpara>Load balancers</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<itemizedlist xml:id="Deploying_conversion_hosts">
<title>Deploying conversion hosts</title>
<listitem>
<simpara>Create an appropriate number of conversion hosts. See <xref linkend="Deciding_how_many_conversion_hosts_to_create"/></simpara>
</listitem>
<listitem>
<simpara>Choose the best datapath transformation option for your environment. See <xref linkend="Choosing_vddk_or_ssh_transformation"/></simpara>
</listitem>
<listitem>
<simpara>Red Hat OpenStack Platform:</simpara>
<itemizedlist>
<listitem>
<simpara>Deploy conversion hosts on multiple compute nodes.</simpara>
</listitem>
<listitem>
<simpara>Deploy conversion hosts on a compute node with nested virtualization enabled. See <link xlink:href="https://docs.openstack.org/devstack/latest/guides/devstack-with-nested-kvm.html">Configure DevStack with KVM-based Nested Virtualization</link>. Nested virtualization is a technology preview.</simpara>
</listitem>
</itemizedlist>
</listitem>
</itemizedlist>
<itemizedlist xml:id="Controlling_the_migration_process">
<title>Controlling the migration process</title>
<listitem>
<simpara>Create multiple <link linkend="Creating_and_running_a_migration_plan">migration plans</link> for finer control.</simpara>
</listitem>
<listitem>
<simpara>Perform test migrations with different maximum numbers of concurrent migrations to assess the capabilities of your environment’s infrastructure (see <xref linkend="Changing_the_maximum_number_of_concurrent_migrations"/>).</simpara>
</listitem>
</itemizedlist>
</section>
</chapter>
<chapter xml:id="Preparing_the_environment_for_migration">
<title>Preparing the environment for migration</title>
<simpara>Preparing your environment for migration involves the following key steps:</simpara>
<itemizedlist>
<listitem>
<simpara>Preparing the VMware environment. See <xref linkend="Preparing_the_vmware_source_environment"/>.</simpara>
</listitem>
<listitem>
<simpara>Preparing the target environment:</simpara>
<itemizedlist>
<listitem>
<simpara><xref linkend="Preparing_the_rhv_target_environment"/></simpara>
</listitem>
<listitem>
<simpara><xref linkend="Preparing_the_osp_target_environment"/></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Configuring the conversion hosts. See <xref linkend="Configuring_the_conversion_hosts"/></simpara>
</listitem>
</itemizedlist>
<section xml:id="Preparing_the_vmware_source_environment">
<title>Preparing the VMware source environment</title>
<simpara>Preparing the VMware source environment involves the following tasks:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Preparing the VMware network. See <xref linkend="Preparing_the_vmware_network"/>.</simpara>
</listitem>
<listitem>
<simpara>Preparing the VMware virtual machines. See <xref linkend="Preparing_the_source_virtual_machines"/>.</simpara>
</listitem>
<listitem>
<simpara>Configuring the VMware hypervisors for SSH transformation, if necessary. See <xref linkend="Configuring_the_vmware_hypervisors_for_ssh_transformation"/>.</simpara>
</listitem>
</orderedlist>
<section xml:id="Preparing_the_vmware_network">
<title>Preparing the VMware network</title>
<simpara>Extend the VMware network to the target environment.</simpara>
<important>
<itemizedlist>
<listitem>
<simpara>The network configuration must not be changed in any way during the migration.</simpara>
</listitem>
<listitem>
<simpara>IP addresses, VLANs, and other network configurations should not be changed before or after migration because the conversion process preserves the source virtual machine MAC addresses.</simpara>
</listitem>
</itemizedlist>
</important>
</section>
<section xml:id="Preparing_the_source_virtual_machines">
<title>Preparing the VMware virtual machines</title>
<simpara>Perform the following steps on each VMware virtual machine that you are migrating:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Install VMware Tools to capture IP addresses. For download and installation instructions, navigate to <link xlink:href="https://www.vmware.com/support/ws5/doc/new_guest_tools_ws.html">
VMware Workstation 5.0 Installing VMware Tools</link>.</simpara>
</listitem>
<listitem>
<simpara>Unmount mounted ISO/CDROM disks.</simpara>
</listitem>
<listitem>
<simpara>Ensure that attached disks are not encrypted.</simpara>
</listitem>
<listitem>
<simpara>Ensure that each NIC has no more than one IPv4 and/or one IPv6 address.</simpara>
</listitem>
<listitem>
<simpara>Ensure that the virtual machine names contain only upper- or lower-case letters, numbers, underscores (<literal>_</literal>), hyphens (<literal>-</literal>), or periods (<literal>.</literal>).</simpara>
<note>
<simpara>International characters and spaces are not permitted.</simpara>
</note>
</listitem>
<listitem>
<simpara>Ensure that source virtual machine names do not duplicate target machine names for the appropriate scope:</simpara>
<itemizedlist>
<listitem>
<simpara>Red Hat Virtualization: Within the entire environment</simpara>
</listitem>
<listitem>
<simpara>Red Hat OpenStack Platform: Within a single tenant</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
<simpara>If you are using VDDK transformation, you are ready to prepare the target environment. See <xref linkend="Preparing_the_rhv_target_environment"/> or Preparing_the_osp_target_environment.</simpara>
<simpara>If you are using SSH transformation, you should prepare the VMware hypervisors. See  <xref linkend="Configuring_the_vmware_hypervisors_for_ssh_transformation"/>.</simpara>
</section>
<section xml:id="Configuring_the_vmware_hypervisors_for_ssh_transformation">
<title>Preparing the VMware hypervisors for SSH transformation</title>
<simpara>SSH transformation requires the VMware hypervisors to be configured for passwordless access by the conversion hosts:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Enable SSH access on each VMware hypervisor:</simpara>
<simpara>For instructions, navigate to <link xlink:href="https://docs.vmware.com/en/VMware-vSphere/index.html">VMware vSphere Documentation</link>. In the navigation pane, click <menuchoice><guimenu>vSphere <emphasis>version</emphasis></guimenu> <guisubmenu>ESXi and vCenter Server</guisubmenu> <guisubmenu>VMware ESXi Installation and Setup</guisubmenu> <guisubmenu>Installing and Setting Up ESXi</guisubmenu> <guisubmenu>Setting Up ESXi</guisubmenu> <guimenuitem>Enable ESXi Shell and SSH Access with the Direct Console User Interface</guimenuitem></menuchoice>.</simpara>
<note>
<simpara>If your security policies allow you to collect the VMware hypervisors' public keys at this stage, save them for <xref linkend="Configuring_the_conversion_hosts"/>.</simpara>
</note>
</listitem>
<listitem>
<simpara>Generate an SSH key pair without a passphrase:</simpara>
<screen># ssh-keygen -N ''</screen>
</listitem>
<listitem>
<simpara>Copy the public SSH key to <literal>/etc/ssh/keys-root/authorized_keys</literal> on <emphasis role="strong">each</emphasis> VMware hypervisor. (The private key is used in <xref linkend="Configuring_the_conversion_hosts"/>.)</simpara>
</listitem>
</orderedlist>
<important>
<simpara>A single SSH key pair for all conversion hosts is recommended because the key pair is used only for virtual machine conversion and it simplifies conversion host management.</simpara>
<simpara>If you wish to use a dedicated SSH key pair for each conversion host, you can create multiple key pairs. You must copy all the public keys to each VMware hypervisor.</simpara>
</important>
<simpara>You are ready to prepare the target environment.</simpara>
</section>
</section>
<section xml:id="Preparing_the_rhv_target_environment">
<title>Preparing the Red Hat Virtualization environment</title>
<simpara>Preparing the Red Hat Virtualization environment involves the following key steps:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Installing and configuring Red Hat Virtualization 4.2</simpara>
</listitem>
<listitem>
<simpara>Installing and configuring CloudForms 4.7.3</simpara>
</listitem>
<listitem>
<simpara>Reinstalling <literal>ipa-client</literal>, if you are configuring the conversion hosts to use SSSD with single sign-on</simpara>
</listitem>
</orderedlist>
<formalpara xml:id="Target_prerequisites_rhv">
<title>Prerequisites</title>
<para>The following prerequisites apply:</para>
</formalpara>
<itemizedlist xml:id="ref_Software_compatibility_matrix_rhv">
<listitem>
<simpara>Compatible software versions</simpara>
<table frame="all" rowsep="1" colsep="1">
<title>Software compatibility matrix</title>
<tgroup cols="3">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<thead>
<row>
<entry align="left" valign="top">Software</entry>
<entry align="left" valign="top">IMS 1.0</entry>
<entry align="left" valign="top">IMS 1.1</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>VMware</simpara></entry>
<entry align="left" valign="top"><simpara>5.5 or later</simpara></entry>
<entry align="left" valign="top"><simpara>5.5 or later</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Red Hat Virtualization</simpara></entry>
<entry align="left" valign="top"><simpara>4.2.7</simpara></entry>
<entry align="left" valign="top"><simpara>4.2.8</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>CloudForms</simpara></entry>
<entry align="left" valign="top"><simpara>4.6</simpara></entry>
<entry align="left" valign="top"><simpara>4.7.3, with CFME 5.10.3 (see note below)</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Red Hat OpenStack Platform</simpara></entry>
<entry align="left" valign="top"><simpara>N/A</simpara></entry>
<entry align="left" valign="top"><simpara>13 or later</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>RHOSP V2V Image for Red Hat OpenStack Director</simpara></entry>
<entry align="left" valign="top"><simpara>N/A</simpara></entry>
<entry align="left" valign="top"><simpara>14.0.2</simpara></entry>
</row>
</tbody>
</tgroup>
</table>
<important>
<simpara><emphasis role="strong">CFME 5.10.4</emphasis> does not support migration.</simpara>
</important>
</listitem>
<listitem>
<simpara>BIOS settings of physical hosts adjusted for optimal performance (rather than power-saving), according to the vendor’s recommendations</simpara>
</listitem>
<listitem>
<simpara>C1E halt state disabled, if applicable
:rhv!:</simpara>
</listitem>
</itemizedlist>
<section xml:id="Installing_and_configuring_red_hat_virtualization">
<title>Installing and configuring Red Hat Virtualization 4.2</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>Install Red Hat Virtualization Manager 4.2 on the Manager machine. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html-single/installation_guide/#part-Installing_the_Red_Hat_Virtualization_Manager">Installing the Red Hat Virtualization Manager</link> in the <emphasis>Red Hat Virtualization Installation Guide</emphasis>.</simpara>
</listitem>
<listitem>
<simpara>Install Red Hat Virtualization Host 4.2 or Red Hat Enterprise Linux 7.6 on physical machines. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html-single/installation_guide/#Installing_RHVH">Installing Red Hat Virtualization Host</link> or <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html-single/installation_guide/#Red_Hat_Enterprise_Linux_Hosts">Installing Red Hat Enterprise Linux Hosts</link> in the <emphasis>Red Hat Virtualization Installation Guide</emphasis>.</simpara>
<note>
<simpara>Some of these hosts will be deployed as conversion hosts. The number of conversion hosts depends on your migration size and infrastructure capabilities. See <xref linkend="Deciding_how_many_conversion_hosts_to_create"/> for details.</simpara>
</note>
</listitem>
<listitem>
<simpara>Enable the following ports in the conversion host network:</simpara>
<itemizedlist>
<listitem>
<simpara>22 - SSH</simpara>
</listitem>
<listitem>
<simpara>443 - CloudForms, Red Hat Virtualization Manager, and VDDK</simpara>
</listitem>
<listitem>
<simpara>902 - CloudForms to VMware</simpara>
</listitem>
<listitem>
<simpara>5480 - Conversion hosts to vCenter</simpara>
<simpara>For details, see <link xlink:href="https://access.redhat.com/articles/417343">Ports used by Red Hat CloudForms Management Engine 5.1 and above</link>.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Create and attach data and ISO storage domains to the data center, ensuring that the data domains have sufficient space for the migrated virtual machines. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html-single/administration_guide/#chap-Storage">Storage</link> in the <emphasis>Red Hat Virtualization Administration Guide</emphasis>.</simpara>
<note>
<simpara>IMS only supports shared storage, such as NFS, iSCSI, or FCP. Local storage is not supported.</simpara>
</note>
</listitem>
<listitem>
<simpara>Upload the VirtIO and Guest Tool image files to the ISO storage domain. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html-single/administration_guide/#Uploading_the_VirtIO_and_Guest_Tool_Image_Files_to_an_ISO_Storage_Domain">Uploading the VirtIO and Guest Tool Image Files to an ISO Storage Domain</link> in the <emphasis>Red Hat Virtualization Administration Guide</emphasis>.</simpara>
<simpara>The VirtIO file name must include the version number: <literal>virtio-win-<emphasis>version</emphasis>.iso</literal>. The Guest Tool is required for migrating Windows virtual machines.</simpara>
</listitem>
<listitem>
<simpara>Optionally, you can create a MAC address pool that includes the MAC addresses of the VMware virtual machines to be migrated. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_virtualization/4.2/html/administration_guide/sect-mac_address_pools#Creating_MAC_Address_Pools">Creating MAC Address Pools</link> in the <emphasis>Red Hat Virtualization Administration Guide</emphasis>.</simpara>
<important>
<simpara>If the Red Hat Virtualization MAC address pool range overlaps the VMware MAC address range, you must ensure that the MAC addresses of the migrating virtual machines do not duplicate those of existing virtual machines. Otherwise, the migration will fail.</simpara>
<simpara>If you do not create a MAC address pool, the migrated virtual machines will not have MAC addresses in the same range as virtual machines created in Red Hat Virtualization.</simpara>
</important>
</listitem>
</orderedlist>
</section>
<section xml:id="Reinstalling_ipa_client">
<title>Reinstalling <literal>ipa-client</literal></title>
<simpara>If you are configuring the conversion hosts to use SSSD with single sign-on, you should reinstall <literal>ipa-client</literal> without the OpenSSH client. Otherwise, SSH will fail for the vdsm user. See <link xlink:href="https://bugzilla.redhat.com/show_bug.cgi?id=1544379">ipa-client-install changes system-wide SSH configuration</link>. This issue cannot be resolved by modifying the configuration file because the file is restored during upgrades.</simpara>
<simpara>On the Manager machine, run the following commands:</simpara>
<screen># ipa-client-install --uninstall
# ipa-client-install --no-ssh</screen>
</section>
<section xml:id="Installing_cf_4_7_3_for_rhv">
<title>Installing and configuring CloudForms 4.7.3</title>
<orderedlist xml:id="Cloudforms_for_rhv" numeration="arabic">
<listitem>
<simpara>Install Red Hat CloudForms 4.7.3 on the Manager machine. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.7/html/installing_red_hat_cloudforms_on_red_hat_virtualization">Installing Red Hat CloudForms on Red Hat Virtualization</link>.</simpara>
<important>
<simpara>CFME 5.10.4 does not support migration. See the <link linkend="ref_Software_compatibility_matrix_rhv">software compatibility matrix</link> for details.</simpara>
</important>
</listitem>
<listitem>
<simpara>Add VMware and Red Hat Virtualization as providers. See <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.7/html-single/managing_providers/#vmware_vcenter_providers">Adding a VMware vCenter Provider</link> and <link xlink:href="https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.7/html-single/managing_providers/#adding_a_red_hat_virtualization_provider">Adding a Red Hat Virtualization Provider</link> in <emphasis>Red Hat CloudForms: Managing Providers</emphasis>.</simpara>
<note>
<simpara>Removing or changing a provider, including refreshing hosts, before, during, or after the migration will cause errors in the infrastructure mappings and migration plans.</simpara>
</note>
<simpara>You are ready to <link linkend="Configuring_the_rhv_conversion_hosts">configure the conversion hosts</link>.</simpara>
</listitem>
</orderedlist>
</section>
</section>
</chapter>
</book>